---
# yaml-language-server: $schema=https://kubernetes-schemas.pages.dev/source.toolkit.fluxcd.io/ocirepository_v1.json
apiVersion: source.toolkit.fluxcd.io/v1
kind: OCIRepository
metadata:
  name: forgejo
spec:
  interval: 12h
  layerSelector:
    mediaType: application/vnd.cncf.helm.chart.content.v1.tar+gzip
    operation: copy
  ref:
    tag: 16.0.2
  url: oci://code.forgejo.org/forgejo-helm/forgejo
---
# yaml-language-server: $schema=https://kubernetes-schemas.pages.dev/v1/persistentvolumeclaim.json
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: forgejo-data
spec:
  accessModes: ["ReadWriteOnce"]
  storageClassName: longhorn
  resources:
    requests:
      storage: 16Gi
---
# yaml-language-server: $schema=https://kubernetes-schemas.pages.dev/helm.toolkit.fluxcd.io/helmrelease_v2.json
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: &name forgejo
spec:
  interval: 1h
  chartRef:
    kind: OCIRepository
    name: forgejo
  values:
    valkey-cluster:
      enabled: false
    valkey:
      enabled: false
    postgresql-ha:
      enabled: false
    postgresql:
      enabled: false

    persistence:
      enabled: true
      create: false
      claimName: forgejo-data

    replicaCount: 1
    strategy:
      type: Recreate
    resources:
      requests:
        cpu: 50m
        memory: 128Mi
      limits:
        cpu: 500m
        memory: 512Mi

    gitea:
      admin:
        email: ${USER_EMAIL}
        username: ${USER_USERNAME}
        password: ${SERVICES_INIT_PASSWORD}
        passwordMode: initialOnlyNoReset
      config:
        database:
          DB_TYPE: postgres
          HOST: ${POSTGRES_HOSTNAME}
          NAME: forgejo
          USER: forgejo
          PASSWD: ${POSTGRES_FORGEJO_PASSWORD}
          SCHEMA: public
        cache:
          ADAPTER: memory
        session:
          PROVIDER: memory
          COOKIE_SECURE: true
          SAME_SITE: strict
        server:
          DOMAIN: git.${CLUSTER_DOMAIN}
          ROOT_URL: https://git.${CLUSTER_DOMAIN}
        mailer:
          ENABLED: true
          FROM: "Forgejo <forgejo@${CLUSTER_DOMAIN}>"
          PROTOCOL: smtp+starttls
          SMTP_ADDR: ${SMTP_HOSTNAME}
          SMTP_PORT: ${SMTP_PORT}
          USER: ${SMTP_USERNAME}
          PASSWD: ${SMTP_PASSWORD}
        migrations:
          ALLOWED_DOMAINS: "github.com,*.github.com,gitlab.com,*.gitlab.com"
        repository:
          DEFAULT_PRIVATE: private
        storage:
          STORAGE_TYPE: local
    httpRoute:
      enabled: true
      hostnames: [ "git.${CLUSTER_DOMAIN}" ]
      parentRefs:
        - name: external
          namespace: gateway
