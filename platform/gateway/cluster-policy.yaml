apiVersion: kyverno.io/v1
kind: ClusterPolicy
metadata:
  name: httproute-authelia-security-policy
  annotations:
    policies.kyverno.io/title: Generate SecurityPolicy & ReferenceGrant for Authelia HTTPRoutes
    policies.kyverno.io/category: Security
    policies.kyverno.io/subject: HTTPRoute, SecurityPolicy, ReferenceGrant
    policies.kyverno.io/description: >-
      This policy generates a SecurityPolicy resource for HTTPRoutes
      that are labeled with 'auth: authelia'.
spec:
  generateExisting: true
  rules:
    - name: generate-authelia-security-policy
      match:
        any:
          - resources:
              kinds:
                - HTTPRoute
              selector:
                matchLabels:
                  cluster.routine.sh/authorization: authelia
      generate:
        apiVersion: gateway.envoyproxy.io/v1alpha1
        kind: SecurityPolicy
        name: "{{request.object.metadata.name}}-authelia-authorization"
        namespace: "{{request.object.metadata.namespace}}"
        synchronize: true
        data:
          metadata:
            labels:
              generated-by: kyverno
              source-httproute: "{{request.object.metadata.namespace}}-{{request.object.metadata.name}}"
          spec:
            targetRefs:
            - group: gateway.networking.k8s.io
              kind: HTTPRoute
              name: "{{request.object.metadata.name}}"
            # Add your SecurityPolicy spec here
            extAuth:
              headersToExtAuth:
                - accept
                - cookie
                - authorization
                - header-authorization
                - x-forwarded-proto
              failOpen: false
              http:
                backendRefs:
                  - name: authelia
                    namespace: authelia
                    port: 80
                path: /api/authz/ext-authz/
                headersToBackend:
                  - Remote-User
                  - Remote-Groups
                  - Remote-Name
                  - Remote-Email
    - name: generate-authelia-reference-grant
      match:
        any:
          - resources:
              kinds:
                - HTTPRoute
              selector:
                matchLabels:
                  cluster.routine.sh/authorization: authelia
      generate:
        apiVersion: gateway.networking.k8s.io/v1beta1
        kind: ReferenceGrant
        name: "{{request.object.metadata.namespace}}-{{request.object.metadata.name}}-authelia"
        namespace: "authelia"
        synchronize: true
        data:
          metadata:
            labels:
              generated-by: kyverno
              source-httproute: "{{request.object.metadata.name}}"
          spec:
            from:
            - group: gateway.envoyproxy.io
              kind: SecurityPolicy
              namespace: "{{request.object.metadata.namespace}}"
            to:
            - group: ""
              kind: Service
