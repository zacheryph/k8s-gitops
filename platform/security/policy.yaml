---
# yaml-language-server: $schema=https://kubernetes-schemas.pages.dev/kyverno.io/clusterpolicy_v1.json
apiVersion: kyverno.io/v1
kind: ClusterPolicy
metadata:
  name: httproute-tinyauth-security-policy
  annotations:
    policies.kyverno.io/title: Generate SecurityPolicy & ReferenceGrant for Tinyauth HTTPRoutes
    policies.kyverno.io/category: Security
    policies.kyverno.io/subject: HTTPRoute, SecurityPolicy, ReferenceGrant
    policies.kyverno.io/description: >-
      This policy generates a SecurityPolicy resource for HTTPRoutes
      that are labeled with 'auth: tinyauth'.
spec:
  generateExisting: true
  rules:
    - name: generate-tinyauth-security-policy
      match:
        any:
          - resources:
              kinds:
                - HTTPRoute
              selector:
                matchLabels:
                  cluster.routine.sh/authorization: tinyauth
      generate:
        apiVersion: gateway.envoyproxy.io/v1alpha1
        kind: SecurityPolicy
        name: "{{request.object.metadata.name}}-tinyauth-authorization"
        namespace: "{{request.object.metadata.namespace}}"
        synchronize: true
        data:
          metadata:
            labels:
              generated-by: kyverno
              source-httproute: "{{request.object.metadata.namespace}}-{{request.object.metadata.name}}"
          spec:
            targetRefs:
            - group: gateway.networking.k8s.io
              kind: HTTPRoute
              name: "{{request.object.metadata.name}}"
            extAuth:
              headersToExtAuth:
                - accept
                - cookie
                - authorization
                - header-authorization
                - x-forwarded-proto
              failOpen: false
              http:
                backendRefs:
                  - name: tinyauth
                    namespace: security
                    port: 80
                path: /api/auth/pocketid
                headersToBackend:
                  - Remote-User
                  - Remote-Groups
                  - Remote-Name
                  - Remote-Email
    - name: generate-tinyauth-reference-grant
      match:
        any:
          - resources:
              kinds:
                - HTTPRoute
              selector:
                matchLabels:
                  cluster.routine.sh/authorization: tinyauth
      generate:
        apiVersion: gateway.networking.k8s.io/v1beta1
        kind: ReferenceGrant
        name: "{{request.object.metadata.namespace}}-{{request.object.metadata.name}}-tinyauth"
        namespace: "security"
        synchronize: true
        data:
          metadata:
            labels:
              generated-by: kyverno
              source-httproute: "{{request.object.metadata.name}}"
          spec:
            from:
            - group: gateway.envoyproxy.io
              kind: SecurityPolicy
              namespace: "{{request.object.metadata.namespace}}"
            to:
            - group: ""
              kind: Service
---
# yaml-language-server: $schema=https://kubernetes-schemas.pages.dev/kyverno.io/clusterpolicy_v1.json
apiVersion: kyverno.io/v1
kind: ClusterPolicy
metadata:
  name: httproute-oauth2-proxy-security-policy
  annotations:
    policies.kyverno.io/title: Generate SecurityPolicy & ReferenceGrant for OAuth2-Proxy HTTPRoutes
    policies.kyverno.io/category: Security
    policies.kyverno.io/subject: HTTPRoute, SecurityPolicy, ReferenceGrant
    policies.kyverno.io/description: >-
      This policy generates a SecurityPolicy resource for HTTPRoutes
      that are labeled with 'auth: oauth2-proxy'.
spec:
  generateExisting: true
  rules:
    - name: generate-oauth2-proxy-security-policy
      match:
        any:
          - resources:
              kinds:
                - HTTPRoute
              selector:
                matchLabels:
                  cluster.routine.sh/authorization: oauth2-proxy
      generate:
        apiVersion: gateway.envoyproxy.io/v1alpha1
        kind: SecurityPolicy
        name: "{{request.object.metadata.name}}-oauth2-proxy-authorization"
        namespace: "{{request.object.metadata.namespace}}"
        synchronize: true
        data:
          metadata:
            labels:
              generated-by: kyverno
              source-httproute: "{{request.object.metadata.namespace}}-{{request.object.metadata.name}}"
          spec:
            targetRefs:
            - group: gateway.networking.k8s.io
              kind: HTTPRoute
              name: "{{request.object.metadata.name}}"
            extAuth:
              headersToExtAuth:
                - accept
                - cookie
                - authorization
                - header-authorization
                - x-forwarded-proto
                - x-forwarded-host
                - x-forwarded-uri
              failOpen: false
              http:
                backendRefs:
                  - name: oauth2-proxy
                    namespace: security
                    port: 80
                path: /proxy/auth
                headersToBackend:
                  - Remote-User
                  - Remote-Groups
                  - Remote-Name
                  - Remote-Email
    - name: generate-oauth2-proxy-reference-grant
      match:
        any:
          - resources:
              kinds:
                - HTTPRoute
              selector:
                matchLabels:
                  cluster.routine.sh/authorization: oauth2-proxy
      generate:
        apiVersion: gateway.networking.k8s.io/v1beta1
        kind: ReferenceGrant
        name: "{{request.object.metadata.namespace}}-{{request.object.metadata.name}}-oauth2-proxy"
        namespace: "security"
        synchronize: true
        data:
          metadata:
            labels:
              generated-by: kyverno
              source-httproute: "{{request.object.metadata.name}}"
          spec:
            from:
            - group: gateway.envoyproxy.io
              kind: SecurityPolicy
              namespace: "{{request.object.metadata.namespace}}"
            to:
            - group: ""
              kind: Service
