---
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: minio
spec:
  interval: 5m
  chart:
    spec:
      # renovate: registryUrl=https://vmware-tanzu.github.io/helm-charts
      chart: minio
      version: 3.6.6
      sourceRef:
        kind: HelmRepository
        name: minio
        namespace: flux-system
      interval: 5m
  values:
    image:
      repository: quay.io/minio/minio
      tag: RELEASE.2022-08-05T23-27-09Z
    mcImage:
      repository: quay.io/minio/mc
      tag: RELEASE.2022-08-05T08-01-28Z
    mode: standalone

    rootUser: ${MINIO_ROOT_ACCESS_KEY}
    rootPassword: ${MINIO_ROOT_SECRET_KEY}

    service:
      port: "80"
      targetPort: "9000"

    persistence:
      enabled: true
      existingClaim: object-pool

    # due to synology nfs "not supporting" file locks
    # we hijack the multipart directory to allow these
    # style uploads. this effects gitea primarily.
    # https://github.com/minio/minio/issues/14522
    extraVolumes:
    - name: multipart
      emptyDir:
        sizeLimit: 1Gi
    extraVolumeMounts:
    - name: multipart
      mountPath: /export/.minio.sys/multipart

    metrics:
      serviceMonitor:
        enabled: true

    resources:
      requests:
        memory: 350Mi
        cpu: 25m
      limits:
        memory: 1000Mi
