---
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: minio
spec:
  interval: 5m
  chart:
    spec:
      # renovate: registryUrl=https://charts.min.io/
      chart: minio
      version: 4.0.13
      sourceRef:
        kind: HelmRepository
        name: minio
        namespace: flux-system
      interval: 5m
  values:
    image:
      repository: quay.io/minio/minio
      tag: RELEASE.2022-09-01T23-53-36Z
    mcImage:
      repository: quay.io/minio/mc
      tag: RELEASE.2022-08-28T20-08-11Z

    mode: standalone
    rootUser: ${MINIO_ROOT_ACCESS_KEY}
    rootPassword: ${MINIO_ROOT_SECRET_KEY}

    service:
      port: "80"
      targetPort: "9000"

    persistence:
      enabled: true
      existingClaim: minio-data

    metrics:
      serviceMonitor:
        enabled: true

    policies:
    - name: context
      statements:
      - resources:
        - "arn:aws:s3:::family/*"
        - "arn:aws:s3:::private/*"
        actions:
        - "s3:*"
    - name: grafana-tempo
      statements:
      - resources:
        - "arn:aws:s3:::grafana-tempo/*"
        actions:
        - "s3:*"
    - name: knative
      statements:
      - resources:
        - "arn:aws:s3:::knative/*"
        actions:
        - "s3:*"
    - name: outline
      statements:
      - resources:
        - "arn:aws:s3:::outline-storage/*"
        actions:
        - "s3:*"
    users:
    - policy: grafana-tempo
      accessKey: ${TEMPO_S3_ACCESS_KEY}
      secretKey: ${TEMPO_S3_SECRET_KEY}
    - policy: knative
      accessKey: ${KNATIVE_S3_ACCESS_KEY}
      secretKey: ${KNATIVE_S3_SECRET_KEY}
    - policy: outline
      accessKey: ${OUTLINE_AWS_ACCESS_KEY_ID}
      secretKey: ${OUTLINE_AWS_SECRET_ACCESS_KEY}
    buckets:
    - name: private
      policy: none
    - name: family
      policy: download
    - name: grafana-tempo
      policy: none
    - name: knative
      policy: none
    - name: outline
      policy: none

    resources:
      requests:
        memory: 350Mi
        cpu: 25m
      limits:
        memory: 1000Mi
