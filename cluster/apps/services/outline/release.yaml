apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: outline
spec:
  interval: 1h
  chart:
    spec:
      chart: charts/kah-common
      sourceRef:
        kind: GitRepository
        name: flux-system
        namespace: flux-system
  values:
    nameOverride: outline
    env:
      OIDC_SCOPES: "openid profile email"
    envFrom:
    - configMapRef:
        name: outline-env

    image:
      repository: outlinewiki/outline
      tag: 0.66.3

    controller:
      type: deployment
      annotations:
        reloader.stakater.com/auto: "true"

    initContainers:
      migrations:
        image: outlinewiki/outline:0.66.3
        command: ["yarn", "sequelize", "db:migrate"]
        envFrom:
        - configMapRef:
            name: outline-env

    service:
      main:
        ports:
          http:
            port: 80
            targetPort: 3000
