apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: victoria-metrics-k8s-stack
spec:
  interval: 1h
  chart:
    spec:
      # registryUrl=https://victoriametrics.github.io/helm-charts/
      chart: victoria-metrics-k8s-stack
      version: 0.2.7
      sourceRef:
        kind: HelmRepository
        name: victoria-metrics
        namespace: flux-system

  # we are only interested in this chart for
  # the operator and k8s specific monitors/rules
  values:
    # Operator
    operator:
      cleanupCRD: true
    victoria-metrics-operator:
      fullnameOverride: victoria-metrics-operator
      image:
        repository: victoriametrics/operator
        tag: v0.15.1
        pullPolicy: IfNotPresent
      operator:
        disable_prometheus_converter: false
        enable_converter_ownership: true
      resources:
        limits:
          cpu: 250m
          memory: 1Gi

    # services/rules
    defaultRules:
      create: true
      rules:
        etcd: true
        general: true
        k8s: true
        kubeApiserver: true
        kubeApiserverAvailability: true
        kubeApiserverSlos: true
        kubelet: true
        kubePrometheusGeneral: true
        kubePrometheusNodeRecording: true
        kubernetesApps: true
        kubernetesResources: true
        kubernetesStorage: true
        kubernetesSystem: true
        kubeScheduler: true
        kubeStateMetrics: true
        network: true
        node: true

    # source specific enablement
    kubelet:
      enabled: true
    kubeApiServer:
      enabled: true
    kubeControllerManager:
      enabled: false
    coreDns:
      enabled: true
    kubeEtcd:
      enabled: false
    kubeScheduler:
      enabled: false
    kubeProxy:
      enabled: false

    # everything else is handled in apps/system-monitor
    vmsingle:
      enabled: false
    alertmanager:
      enabled: false
    vmalert:
      enabled: false
    vmagent:
      enabled: false
    grafana:
      enabled: false
    prometheus-node-exporter:
      enabled: false
    kube-state-metrics:
      enabled: false
